<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="by Yan Holtz - 10 April 2018" />


<title>Finding the best parameters for my algorythm</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Crypto Adventures</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Intro</a>
</li>
<li>
  <a href="1_Call_Public_API.html">Public API</a>
</li>
<li>
  <a href="2_Cheapest_Exchange.html">Cheapest Exchange</a>
</li>
<li>
  <a href="3_What_is_Arbitrage.html">Arbitrage: definition</a>
</li>
<li>
  <a href="4_Looking_for_arbitrage_opportunity.html">Opportunity hunting</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<a href="https://github.com/holtzy/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#2ecc71; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Finding the best parameters for my algorythm</h1>
<h4 class="author"><em>by <a href="https://github.com/holtzy/">Yan Holtz</a> - 10 April 2018</em></h4>

</div>


<p><br><br></p>
<blockquote>
<p>This document simulates the creation of a cryptocurrency arbitrage bot. The algorithm is created and described. It is then run on an historical dataset. Parameters optimization is finally performed.</p>
</blockquote>
<pre class="r"><code>library(tidyverse)
library(rmarkdown)    # You need this library to run this template.
library(epuRate)      # Install with devtools: install_github(&quot;holtzy/epuRate&quot;, force=TRUE)
library(DT)
library(plotly)
library(hrbrthemes)
library(lubridate)</code></pre>
<div id="dataset" class="section level1">
<h1><span class="header-section-number">1</span> - Dataset</h1>
<hr />
<p>This document is based on a dataset described here and available here. We will use the price of bitcoin cash (BCH) between bitstamp and Cex, since we saw that it is here that the best arbitrage opportunities exist.</p>
<pre class="r"><code># Load result
load(&quot;DATA/public_ticker_harvest.Rdata&quot;)
Ticker= head(Ticker, 300000)</code></pre>
<p>Clean and reformat the ticker</p>
<pre class="r"><code># Choose 2 exchanges
plat1 &lt;- &quot;Bitstamp&quot;
plat2 &lt;- &quot;Cex&quot;

# Keep the 2 plateform only
data &lt;- Ticker %&gt;% 
    filter(symbol==&quot;BCHEUR&quot;) %&gt;%
    filter(platform %in% c(plat1, plat2)) %&gt;%
    select(time, platform, symbol, ask, bid) %&gt;%
    mutate(ask=as.numeric(ask), bid=as.numeric(bid)) %&gt;%
    gather(temp, value, -time, -platform, -symbol) %&gt;%
    mutate(platform=gsub(plat1,&quot;plat1&quot;, platform)) %&gt;%
    mutate(platform=gsub(plat2,&quot;plat2&quot;, platform)) %&gt;%
    unite(temp1, platform, temp, sep=&quot;_&quot;) %&gt;%
    spread( key=temp1, value=value) %&gt;%
    mutate( 
      diff1=(plat1_bid-plat2_ask)/plat1_bid*100, 
      diff2=(plat2_bid-plat1_ask)/plat2_bid*100
    ) %&gt;%
    na.omit()</code></pre>
</div>
<div id="data-description" class="section level1">
<h1><span class="header-section-number">2</span> - Data description</h1>
<hr />
<p>This plot describe the evolution of the BitcoinCash (BTC) for our 2 platforms.</p>
<pre class="r"><code>ticker_evolution &lt;- Ticker %&gt;%
  mutate(last=as.numeric(last)) %&gt;%
  filter(symbol==&quot;BCHEUR&quot;) %&gt;%
  ggplot( aes(x=time, y=last, color=platform, group=platform)) +
    geom_line() +
    #ylim(5500, 6400) +
    ggtitle(&quot;Last value&quot;)
ticker_evolution</code></pre>
<p><img src="5_Optimize_algorythm_files/figure-html/unnamed-chunk-3-1.png" width="1248" /></p>
<p>And the difference in % between both platform? (= red - blue curve)</p>
<pre class="r"><code>tmp=Ticker %&gt;% 
  mutate(last=as.numeric(last)) %&gt;%
  filter(symbol==&quot;BCHEUR&quot;) %&gt;%
  select(time, platform, last) %&gt;% 
  spread(key=platform, value=last)
tmp$mydiff=tmp[,plat1]-tmp[,plat2] 
tmp$mydiff_perc=tmp$mydiff/ apply(tmp[,c(2,3)],1,mean) *100  

difference=ggplot( data=tmp, aes(x=time, y=mydiff_perc, color=&quot;diff&quot;)) +
    geom_abline(slope=0, intercept=0) +
    geom_abline(slope=0, intercept=2, color=&quot;grey&quot;) +
    geom_abline(slope=0, intercept=-2, color=&quot;grey&quot;) +
    geom_line() +
    ylab(&quot;Difference entre les 2 plateformes (%)&quot;) +
    ggtitle(paste(&quot;difference between &quot;, plat1, &quot; and &quot;, plat2, sep=&quot;&quot;)) +
    theme(legend.position=&quot;none&quot;)
difference</code></pre>
<p><img src="5_Optimize_algorythm_files/figure-html/unnamed-chunk-4-1.png" width="1248" /></p>
</div>
<div id="the-algorythm" class="section level1">
<h1><span class="header-section-number">3</span> - The algorythm</h1>
<hr />
<p>This is a function that run an arbitrage algo on my data. Several parameters have to be given. Here is what it does step by step:</p>
<ul>
<li>1-</li>
<li>2-</li>
<li>3-</li>
<li>4-</li>
</ul>
<pre class="r"><code>#data=data
#thres=2
#thres_rebalance=1
#euro_to_trade=5
#initial_value=100
#fee=0.25

run_arbitrage_algo=function(data, thres, thres_rebalance, euro_to_trade, initial_value, fee){

  # Get platform1 balance:
  init_crypto_plat1 = initial_value / 1000
  init_euro_plat1 = initial_value
  
  # Get platform2 balance:
  init_crypto_plat2 = initial_value / 1000
  init_euro_plat2 = initial_value
  
  # Initialize outputs. I will have one line per iteration of the loop. If I do a transaction , some column will be filled with the appropriate information.
  bilan=as.data.frame(matrix(NA, nrow(data), 22))
  names(bilan) = c(
    &quot;time&quot;, &quot;ask_plat1&quot;, &quot;bid_plat1&quot;, &quot;ask_plat2&quot;, &quot;bid_plat2&quot;, &quot;diff_side1&quot;, &quot;diff_side2&quot;, &quot;transaction&quot;, &quot;rebalance&quot;,
    &quot;thres&quot;, &quot;thres_rebalance&quot;, &quot;euro_to_trade&quot;, &quot;crypto_to_trade&quot;,
    &quot;euro_plat1&quot;, &quot;crypto_plat1&quot;, &quot;euro_plat2&quot;, &quot;crypto_plat2&quot;,
    &quot;total_euro&quot;, &quot;total_crypto&quot;, &quot;total&quot;, &quot;total_without_arbitrage&quot;, &quot;id&quot;
    )
  
  # What I have at the beginning
  current_crypto_plat1=init_crypto_plat1
  current_crypto_plat2=init_crypto_plat2
  current_euro_plat1=init_euro_plat1
  current_euro_plat2=init_euro_plat2
  
  
  # Start the loop
  num=0
  for( i in c(1:nrow(data)) ){
    
    num=num+1

    # ---- Step1: recover price of both platforms
    ask_plat1 = data$plat1_ask[i]  
    bid_plat1 = data$plat1_bid[i]
    ask_plat2 = data$plat2_ask[i]  
    bid_plat2 = data$plat2_bid[i]
      
    # ---- Step2: calculate difference between both plateform? Side1 = platform1 is more expensive. So I buy on plat2 and sell on plat1
    diff_side1 = (bid_plat1 - ask_plat2) / mean( c(bid_plat1,ask_plat2) ) * 100
    diff_side2 = (bid_plat2 - ask_plat1) / mean( c(bid_plat2,ask_plat1) ) * 100

    # ---- Step3: calcule the equivalence crypto / euro --&gt; we need that to trade the good amount
    crypto_to_trade &lt;-  euro_to_trade /  min(bid_plat1, bid_plat2)

    # ---- Step4: Is there a significant difference + have I the money to make a transaction?
    trade_side1 = diff_side1 &gt; thres &amp; current_crypto_plat1&gt;crypto_to_trade &amp; current_euro_plat2&gt;euro_to_trade
    trade_side2 = diff_side2 &gt; thres &amp; current_crypto_plat2&gt;crypto_to_trade &amp; current_euro_plat1&gt;euro_to_trade
    # I can also make a transaction to rebalance my fundings! If I have less than one third of the crypto in a plateform, I re-balance
    tot_crypto = current_crypto_plat1 + current_crypto_plat2
    rebalance_side1 = current_crypto_plat2&lt;tot_crypto/3  &amp; diff_side1 &gt; thres_rebalance &amp; current_crypto_plat1&gt;crypto_to_trade &amp; current_euro_plat2&gt;euro_to_trade
    rebalance_side2 = current_crypto_plat1&lt;tot_crypto/3  &amp; diff_side2 &gt; thres_rebalance &amp; current_crypto_plat2&gt;crypto_to_trade &amp; current_euro_plat1&gt;euro_to_trade
    
    if( trade_side1==TRUE | trade_side2==TRUE | rebalance_side1==TRUE | rebalance_side2==TRUE ){
      
      transaction=&quot;yes&quot;
      if( rebalance_side1==TRUE | rebalance_side2==TRUE ){ rebalance=&quot;yes&quot; }
  
      # -- 4.1 if side1 --&gt; plateform1 &gt; plateform2 --&gt; I buy crypto on plateform2, and I sell crypto on plateform1
      if( trade_side1==TRUE | rebalance_side1==TRUE){
        current_crypto_plat1 &lt;- current_crypto_plat1 - crypto_to_trade
        current_euro_plat1 &lt;- current_euro_plat1 + crypto_to_trade*bid_plat1 * (1-fee/100) 
        current_crypto_plat2 &lt;- current_crypto_plat2 + crypto_to_trade
        current_euro_plat2 &lt;- current_euro_plat2 - crypto_to_trade*ask_plat2 * (1+fee/100) 
       }
      
      # -- 4.2 if side 2 --&gt; plateform1 &lt; plateform2 --&gt; I buy crypto on plateform1, and I sell crypto on plateform2
      if( trade_side2==TRUE | rebalance_side2==TRUE){
        current_crypto_plat1 &lt;- current_crypto_plat1 + crypto_to_trade
        current_euro_plat1 &lt;- (current_euro_plat1 - crypto_to_trade*ask_plat1) 
        current_crypto_plat2 &lt;- current_crypto_plat2 - crypto_to_trade
        current_euro_plat2 &lt;- (current_euro_plat2 + crypto_to_trade*bid_plat2) 
      }
      
    # ---- Step 4: If no significative difference, then I don&#39;t do anything, and NA to the bilan table  
    }else{
      transaction=&quot;no&quot;
      rebalance=&quot;no&quot;
    }
  
    # ---- Step5: make a summary data frame for this time unit and add it to the final output data frame
    total_euro=current_euro_plat1 + current_euro_plat2
    total_crypto=current_crypto_plat1 + current_crypto_plat2
    total= total_euro + current_crypto_plat1*bid_plat1 + current_crypto_plat2*bid_plat2
    total_without_arbitrage= init_euro_plat1 + init_euro_plat2 + init_crypto_plat1*bid_plat1 + init_crypto_plat2*bid_plat2
    bilan[num,]=c( data$time[i], ask_plat1, bid_plat1, ask_plat2, bid_plat2, diff_side1, diff_side2, transaction, rebalance, thres, thres_rebalance, euro_to_trade, crypto_to_trade, current_euro_plat1, current_crypto_plat1, current_euro_plat2, current_crypto_plat2, total_euro, total_crypto, total, total_without_arbitrage, num)
    
  }  
  
  # Turn to numeric a big part of the column:
  bilan[,-c(1,8,9)]  = apply(bilan[,-c(1,8,9)] , 2, function(x) as.numeric(as.character(x)));
  bilan$time &lt;- data$time
  # Return the result
  return(bilan)
}</code></pre>
</div>
<div id="try-the-algo" class="section level1">
<h1><span class="header-section-number">4</span> Try the algo</h1>
<hr />
<p>I try the function with thresolds of 1 and -1. It means than when the difference between 2 platforms is over 1%, I do a transaction.</p>
<pre class="r"><code>bilan = run_arbitrage_algo(data=data, thres=1.9, thres_rebalance=0, euro_to_trade=20, initial_value=1000, fee=0.25)</code></pre>
<p>I can then have a look to the behaviour of the bot:</p>
<pre class="r"><code># Evolution of crypto value on exchange 1 and 2.
a=bilan %&gt;%
  select(time, ask_plat1, ask_plat2) %&gt;%
  gather(plateform, value, -1) %&gt;%
  ggplot( aes(x=time, y=value, color=plateform)) +
    geom_line() +
    ggtitle(&quot;Evolution of last value&quot;) +
    #theme(legend.position=&quot;none&quot;) +
    xlab(&quot;&quot;)

b=bilan %&gt;%
  mutate(vline_transac=ifelse(transaction==&quot;yes&quot; &amp; rebalance==&quot;no&quot;, time, NA)) %&gt;%
  mutate(vline_rebalance=ifelse(transaction==&quot;yes&quot; &amp; rebalance==&quot;yes&quot;, time, NA)) %&gt;%
  mutate(vline_transac=as.POSIXct(vline_transac, origin=&quot;1970-01-01&quot;)) %&gt;%
  mutate(vline_rebalance=as.POSIXct(vline_rebalance, origin=&quot;1970-01-01&quot;)) %&gt;%
  rowwise() %&gt;%
  select(time, diff_side1, diff_side2, transaction, vline_transac, vline_rebalance) %&gt;%
  gather( key=side, value=value, -c(1,4,5,6,7)) %&gt;%
  ggplot(aes(x=time, y=value, color=side)) +
    geom_abline(slope=0, intercept=0, color=&quot;grey&quot;) +
    geom_abline(slope=0, intercept=unique(bilan$thres), color=&quot;grey&quot;, linetype=&quot;dashed&quot;) +
    geom_vline( aes(xintercept=vline_transac), color=&quot;orange&quot;) +
    geom_vline( aes(xintercept=vline_rebalance), color=&quot;pink&quot;) +
    geom_line() +
    #theme(legend.position = c(.15, .15) )
    #theme(legend.position=&quot;none&quot;) +
    #ylim(-3,3)+
    xlab(&quot;&quot;)

# Quantity of euro on both exchanges:
c=bilan %&gt;%
  select(time, euro_plat1, euro_plat2) %&gt;%
  mutate(total=euro_plat1 + euro_plat2) %&gt;%
  gather(plateform, value, -1) %&gt;%
  ggplot( aes(x=time, y=value, color=plateform)) +
    geom_line() +
    #theme(legend.position=&quot;none&quot;) +
    ylab(&quot;Euro&quot;) +
    expand_limits(y=0) +
    xlab(&quot;&quot;)

# Quantity of crypto on both exchanges
d=bilan %&gt;%
  select(time, crypto_plat1, crypto_plat2) %&gt;%
  mutate(total=crypto_plat1 + crypto_plat2) %&gt;%
  gather(plateform, value, -1) %&gt;%
  ggplot( aes(x=time, y=value, color=plateform)) +
    geom_line() +
    #theme(legend.position=&quot;none&quot;) +
    ylab(&quot;Crypto&quot;) +
    expand_limits(y=0) +
    xlab(&quot;&quot;)

# Comparison with / without arbitrage
e=bilan %&gt;%
  select(time, total, total_without_arbitrage) %&gt;%
  gather(plateform, value, -1) %&gt;%
  ggplot( aes(x=time, y=value, color=plateform)) +
    geom_line() +
    #theme(legend.position=&quot;none&quot;) +
    xlab(&quot;&quot;)

# Zoom on the total quantity of euro I have
f=bilan %&gt;%
  ggplot(aes(x=time, y=total_euro, color=&quot;A&quot;)) +
    geom_line() +
    xlab(&quot;&quot;)

g=bilan %&gt;%
  ggplot(aes(x=time, y=gain, color=rebalance)) +
    geom_point() +
    geom_abline(slope=0, size=0.3 ) +
    ylim(-0.2, 0.2) +
    #theme(legend.position=c(.1, .1))+
    xlab(&quot;&quot;)</code></pre>
<pre class="r"><code>library(gridExtra)
grid.arrange(a,b,c,d,e,f, ncol=1)</code></pre>
<p><img src="5_Optimize_algorythm_files/figure-html/unnamed-chunk-8-1.png" width="960" /></p>
<p>Let’s check what happend! The 2 first plots are the same as above.</p>
<p>The 3rd one gives the quantity of euro I have on each platform. When one increase, the other decrease! The blue curve is the total amount of euro I have.</p>
<p>The 4th plot is the same for crypto amount</p>
<p>The 5th plot is the most important. The blue curve describe the total amount of money I would have doing nothing, without arbitrage. It is calculated using:</p>
<p>tot = euro on plat1 + euro on plat2 + crypto on plat 1 x value of crypto on plat1 + crypto on plat 2 x value of crypto on plat1.</p>
<p>The red curve is calculated the same way, but using arbitrage algorythm.</p>
<p>Bilan:</p>
<pre class="r"><code># Number of transaction
nb_transac = bilan %&gt;% filter(transaction==&quot;yes&quot;) %&gt;% nrow()

# Final amount of money I have
final=bilan$total[nrow(bilan)]

# What I would have without arbitrage
final_without = bilan$total_without_arbitrage[nrow(bilan)]
cat(paste(&quot;Money I would have without arbitrage: &quot;, final_without, &quot;\n&quot;))</code></pre>
<pre><code>## Money I would have without arbitrage:  3955.36</code></pre>
<pre class="r"><code># Gain compare to no arbitrage in euro, and in % of investment
# --&gt; This is what I have to optimize
diff=final-final_without
cat(paste(&quot;Difference in euro: &quot;, diff, &quot;\n&quot;))</code></pre>
<pre><code>## Difference in euro:  89.2836225424799</code></pre>
<pre class="r"><code>cat(paste(&quot;Diff in %: &quot;, diff/final_without*100, &quot;\n&quot;))</code></pre>
<pre><code>## Diff in %:  2.25728182877108</code></pre>
<pre class="r"><code># Gain per 24hours?
length = bilan$time[nrow(bilan)] - bilan$time[1]    # In character
length = as.numeric(as.duration(length)) / 3600     # In hours
diff_per_day=24*diff/ length
cat(paste(&quot;Difference in % per 24h &quot;,diff_per_day/final_without*100, &quot;\n&quot;))</code></pre>
<pre><code>## Difference in % per 24h  0.61681812045832</code></pre>
</div>
<div id="optimize" class="section level1">
<h1><span class="header-section-number">5</span> - Optimize</h1>
<hr />
<p>Now that the bot has a correct behaviour, we want to improve its parameters to maximize our profit. We can simulate several parameters until we find the best combination.</p>
<pre class="r"><code>to_try_low= seq(-1,1,0.2)
to_try_high= seq(1.5,3.5,0.4)
mylen=length(to_try_high)*length(to_try_low)
bilan_optimiz=data.frame(matrix(0,mylen,6))
colnames(bilan_optimiz)=c(&quot;lowt&quot;, &quot;hight&quot;, &quot;nb_transaction&quot;, &quot;initial&quot;, &quot;final&quot;, &quot;diff_perc&quot;)
num=0
for(lowt in to_try_low){
  for(hight in to_try_high){
    num=num+1
    #print(paste(lowt, &quot; / &quot;, hight, sep=&quot;&quot;))
    result = run_arbitrage_algo(data=data, thres=hight, thres_rebalance=lowt, euro_to_trade=20, initial_value=1000, fee=0.25)
    nb_transaction=result %&gt;% filter(transaction==&quot;yes&quot;) %&gt;% nrow()
    final=result$total_euro[nrow(result)]
    initial=1000*2
    diff=final-initial
    diff_perc=diff/initial*100
    
    # write the result
    bilan_optimiz[num,]=c(lowt, hight, nb_transaction, initial, final, diff_perc)    
  }
}</code></pre>
<p>Check the result</p>
<pre class="r"><code>bilan_optimiz %&gt;% arrange(desc(diff_perc)) %&gt;% head(5)</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["lowt"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["hight"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["nb_transaction"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["initial"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["final"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["diff_perc"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"-0.2","2":"1.5","3":"443","4":"2000","5":"2089.357","6":"4.467841","_rn_":"1"},{"1":"0.0","2":"1.9","3":"317","4":"2000","5":"2088.701","6":"4.435073","_rn_":"2"},{"1":"0.0","2":"1.5","3":"386","4":"2000","5":"2087.865","6":"4.393261","_rn_":"3"},{"1":"0.2","2":"1.9","3":"299","4":"2000","5":"2086.870","6":"4.343516","_rn_":"4"},{"1":"-0.4","2":"1.5","3":"470","4":"2000","5":"2086.563","6":"4.328152","_rn_":"5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<pre class="r"><code>library(viridis)
p=ggplot(bilan_optimiz, aes(x=lowt, y=hight, fill=diff_perc)) +
  geom_tile() + 
  scale_fill_viridis() +
  theme_minimal()
p</code></pre>
<p><img src="5_Optimize_algorythm_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<pre class="r"><code>#library(plotly)
#ggplotly(p)</code></pre>
<p>Is the best score the one with more transaction –&gt; no, there is a trade off to find!</p>
<pre class="r"><code>ggplot(bilan_optimiz, aes(x=nb_transaction, y=diff_perc)) +
  geom_point()</code></pre>
<p><img src="5_Optimize_algorythm_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>

&nbsp;
<hr />
<p style="text-align: center;">A work by <a href="https://github.com/holtzy/">Yan Holtz</a></p>
<p style="text-align: center;"><span style="color: #808080;"><em>Yan.holtz.data@gmail.com</em></span></p>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Add font awesome icons -->
<p style="text-align: center;">
	<a href="https://twitter.com/r_graph_gallery?lang=en" class="fa fa-twitter"></a>
	<a href="https://www.linkedin.com/in/yan-holtz-2477534a/" class="fa fa-linkedin"></a>
	<a href="https://github.com/holtzy/" class="fa fa-github"></a>
</p>

&nbsp;



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
